作者：easyinfonet
email: zhujs@cec.gov.cn
日期：2001-2-23 9:38:08
6.5 连接管理器
    连接管理器使您可以控制并减少由 Web 应用程序使用的资源。相对于非 Web 应用程序，基于 Web 的应用程序对数据服务器的访问会导致更高的和不可预料的系统开销，这是由于 Web 用户更为频繁的连接和断开。通常连接与断开连接所用的资源大于交互所用的资源。由于 Internet 的“冲浪”性质，用户的交互过程一般都较短。通常，公司外（Internet，而非 intranet）的用户会将使用卷变得很大，并难以预料。连接管理器通过建立用户 Servlet 可用的连接缓冲池将连接的系统开销分摊给多个用户请求。换言之，每个用户请求仅占用连接／断开连接所用系统开销成本的一小部分。在使用初始资源建立缓冲池中的连接后，其余连接／断开连接所用的系统开销就不大了，因为这只是重复使用已有的连接而已。 
    Servlet 以如下方式使用连接缓冲池：当一个用户通过 Web 向 Servlet 请求时， Servlet 从缓冲池使用一个已有的连接，这意味着用户请求不会引起数据服务器的连接系统开销。当满足请求时，Servlet 将连接返回至连接管理器缓冲池供其它 Servlet 使用。因而用户请求不会引起数据服务器的断开连接的系统开销。
    连接管理器还使您能控制到数据服务器产品的并发连接数。当数据服务器的许可证协议限定用户数量时，这一特性是非常有用的。可以为数据服务器创建一个缓冲池，并将连接管理器缓冲池的“最多连接数”参数设成数据服务器产品许可证中限定的最大用户数。如果用其它程序而不用连接管理器连接到数据服务器，则不能保证该方法有效。
1. 连接管理器结构
连接管理器维护一个连接到特定数据服务器产品处于打开状态的数据服务器缓冲池。每个数据服务器可以有一个或多个等同的或非等同的缓冲池。连接管理器的一个运行实例可以支持多个数据服务器。图6-1说明了在连接管理器与一个正在连接管理器的连接缓冲池中寻找可使用的连接的 Servlet 之间的典型交互作用。
    (1) 当第一个 Servlet 试图与连接管理器通信时，由WebSphere应用服务器装入运行在WebSphere应用服务器下的连接管理器。只要WebSphere应用服务器在运行，连接管理器就一直被装入。
    (2) WebSphere应用服务器将用户请求传递给一个 Servlet。
	 (3) Servlet 用连接管理器使用的方法从缓冲池中请求一个连接。 
	 (4) 缓冲池给 Servlet 分配一个连接。 
	(5) Servlet 使用连接与数据服务器直接对话，这一过程中使用的是特定数据服务器的标准 API。 
	(6) 数据服务器通过与 Servlet 的连接返回数据。 
	(7) 当 Servlet 结束与数据服务器通信时，Servlet 把连接归还给连接管理器缓冲池，以供其它 
Servlet 使用。 
	(8) Servlet 通过WebSphere应用服务器向用户发回响应。
    在 Servlet 请求一个连接时，缓冲池中不一定有可用的连接。在这种情况下，连接管理器直接与数据服务器通信。连接管理器将：
    l 请求一个新的连接（参见图6-1中的9 ）。 
    l 将连接添加到缓冲池中（参见图6-1中的10）。如果缓冲池中的连接数达到了规定的上限，连接服务器将不会把新的连接加入缓冲池中。
l 将新的连接交给 Servlet（参见图6-1中的4）。
    2．性能特性
为缓冲池创建一个新的连接是一项系统开销很高的任务，新的连接将使用数据服务器上的资源。因此连接管理器尽量用缓冲池中的现有连接来满足 Servlet 的请求。 同时，连接管理器必须尽可能地最小
图6-1：连接管理器与Servlet 之间的交互

化缓冲池中的空闲连接，因为这是对系统资源的极大浪费。连接管理器与 Servlet 一同执行这些最小化和最大化任务。对于可选的性能，请适当地设置连接管理器参数。
连接管理器维护每个连接的验证时间标记、最近使用时间标记和正在使用标志。当某个 Servlet 第一次获得连接时，连接的验证时间标记和最近使用时间标记被设置为当前时间，连接的正在使用标志则被设置为真。
可将连接服务器配置成从某个 Servlet 中移走一个长时间未使用的连接。这个时间长度是由连接管理器的 “最长周期”参数指定的。如果 Servlet 准备在较长一段时期内使用连接与数据服务器多次通信，可能希望将代码加入 Servlet 中，以便在每次使用连接之前，确认它仍占有这个连接。连接管理器从缓冲池中除去空闲的连接，因为它们会浪费资源。为了确定哪个连接是空闲的，连接管理器将检查连接标志和时间标记，这个操作是通过周期性地获取连接缓冲池信息来实现的：
    (1) 连接管理器查看正在使用连接的最近使用时间标记。如果最近使用时间和当前时间之间的时间差大于“最长周期” 配置参数，则本连接将被认为是一个残留连接，这就表明占有它的 Servlet 已终止或者没有响应。残留连接将被归还给缓冲池以供其它 Servlet 使用，它的正在使用标志被设置为假，且验证和最近使用时间标记被设置为当前时间。 
    (2) 连接管理器检查未被任何 Servlet 使用的连接（这些连接的正在使用标志为假）。如果最近使用时间与当前时间的时间差超过了“最长空闲时间”配置参数，将认为本连接是空闲的。空闲连接将被从缓冲池中除去，降至“最少连接数”配置参数指定的较低限定值。
    3．监控连接管理器
    WebSphere应用服务器管理器为名为数据库缓冲池连接的连接管理器提供了一个监控程序。可以使用这些信息来查看如何执行连接缓冲池，并建议对连接缓冲池参数进行可能的更改。可以在更改参数之后对缓冲池执行监控，从而查看缓冲池特性的更改并帮助进一步对缓冲池参数进行调整。可以选择特定缓冲池，以从选择列表中对其进行监控。
